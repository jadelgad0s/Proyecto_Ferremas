{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% if direccion %}Editar Dirección{% else %}Agregar Dirección{% endif %} | FERREMAS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
</head>
<body class="d-flex flex-column min-vh-100" style="background-color: #f8f9fa;">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg" style="background-color: #005eff;">
    <div class="container">
      <a class="navbar-brand text-white" href="{% url 'Ferremas:index' %}">
        <img src="{% static 'img/LOGO_FERREMAS.png' %}" alt="FERREMAS" height="40">
      </a>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container my-5">
    <h4 class="text-center mb-4">{% if direccion %}Editar Dirección{% else %}Agregar Nueva Dirección{% endif %}</h4>

    <form method="post" class="row g-3">
      {% csrf_token %}

      <div class="col-md-6">
        <label for="calle" class="form-label">Calle</label>
        <input type="text" name="calle" id="calle" class="form-control" required value="{{ direccion.calle|default_if_none:'' }}">
      </div>

      <div class="col-md-6">
        <label for="num_calle" class="form-label">Número</label>
        <input type="text" name="num_calle" id="num_calle" class="form-control" required value="{{ direccion.num_calle|default_if_none:'' }}">
      </div>

      <div class="col-md-6">
        <label for="id_region" class="form-label">Región</label>
        <select name="id_region" id="id_region" class="form-select" required>
          <option value="">Seleccione región</option>
          {% for region in regiones %}
            <option value="{{ region.id }}" {% if direccion and direccion.id_region.id == region.id %}selected{% endif %}>
              {{ region.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6">
        <label for="id_comuna" class="form-label">Comuna</label>
        <select name="id_comuna" id="id_comuna" class="form-select" required>
          <option value="">Seleccione comuna</option>
        </select>
      </div>

      <div class="col-12 text-center mt-4">
        <button type="submit" class="btn btn-primary me-2">{% if direccion %}Guardar Cambios{% else %}Guardar Dirección{% endif %}</button>
        <a href="{% url 'Ferremas:cuenta_cliente' %}" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </div>

  <footer class="text-white text-center py-3 mt-auto" style="background-color: #005eff;">
    <small>&copy; 2025 FERREMAS. Todos los derechos reservados.</small>
  </footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const regionSelect = document.getElementById('id_region');
  const comunaSelect = document.getElementById('id_comuna');

  regionSelect.addEventListener('change', async () => {
    const regionId = regionSelect.value;
    comunaSelect.innerHTML = '<option value="">Cargando comunas...</option>';

    if (!regionId) return;

    try {
      const response = await fetch(`/api/comunas/${regionId}/`);
      if (!response.ok) throw new Error("Error al cargar comunas");

      const comunas = await response.json();

      comunaSelect.innerHTML = '<option value="">Seleccione comuna</option>';
      comunas.forEach(comuna => {
        const option = document.createElement('option');
        option.value = comuna.id;
        option.textContent = comuna.nombre;
        comunaSelect.appendChild(option);
      });
    } catch (error) {
      comunaSelect.innerHTML = '<option value="">Error al cargar comunas</option>';
      console.error("Error:", error);
    }
  });

  // Si hay una región preseleccionada (modo editar), disparamos el evento para precargar comunas
  if (regionSelect.value) {
    regionSelect.dispatchEvent(new Event('change'));
  }
});
</script>
</body> 
</html>