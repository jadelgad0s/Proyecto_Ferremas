<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FERREMAS | Gestión de Pedidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
</head>

<body class="d-flex flex-column min-vh-100" style="background-color: #f8f9fa;">

<!-- HEADER -->
<header class="d-flex justify-content-between align-items-center px-4 py-3 border-bottom bg-white">
  <div class="d-flex align-items-center gap-3">
    <a href="{% url 'Ferremas:vendedor' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i>
    </a>
    <input type="text" class="form-control" name="busqueda" form="filtros-form"
           placeholder="Buscar pedido por número o cliente"
           value="{{ request.GET.busqueda }}" style="width: 300px;">
  </div>
  <div class="d-flex align-items-center gap-3">
    <a href="{% url 'Ferremas:logout' %}" class="btn btn-outline-dark btn-sm">
      <i class="bi bi-box-arrow-right me-1"></i> Salir
    </a>
    <span><i class="bi bi-person-circle me-1"></i> {{ request.session.usuario_nombre }}</span>
  </div>
</header>

<!-- FILTROS -->
<div class="container mt-3">
  <form method="GET" id="filtros-form" class="d-flex flex-wrap align-items-center justify-content-between gap-3">
    <div class="d-flex flex-wrap gap-3 align-items-center">
      <label class="form-check-label fw-bold">Filtros:</label>

      <div class="form-check d-flex align-items-center gap-1">
        <input class="form-check-input" type="checkbox" id="filtroEstado" checked disabled>
        <label class="form-check-label" for="filtroEstado">Estado del Pedido:</label>
        <select name="estado" class="form-select form-select-sm">
          <option value="">Todos</option>
          <option value="Pendiente" {% if request.GET.estado == "Pendiente" %}selected{% endif %}>Pendiente</option>
          <option value="Aprobado" {% if request.GET.estado == "Aprobado" %}selected{% endif %}>Aprobado</option>
          <option value="Rechazado" {% if request.GET.estado == "Rechazado" %}selected{% endif %}>Rechazado</option>
          <option value="Pagado" {% if request.GET.estado == "Pagado" %}selected{% endif %}>Pagado</option>
        </select>
      </div>

      <div class="form-check d-flex align-items-center gap-1">
        <input class="form-check-input" type="checkbox" id="filtroFecha" checked disabled>
        <label class="form-check-label" for="filtroFecha">Fecha:</label>
        <select name="fecha" class="form-select form-select-sm">
          <option value="">Cualquiera</option>
          <option value="Hoy" {% if request.GET.fecha == "Hoy" %}selected{% endif %}>Hoy</option>
          <option value="Ayer" {% if request.GET.fecha == "Ayer" %}selected{% endif %}>Ayer</option>
          <option value="Esta semana" {% if request.GET.fecha == "Esta semana" %}selected{% endif %}>Esta semana</option>
        </select>
      </div>
    </div>
    <button type="submit" class="btn btn-outline-dark">
      <i class="bi bi-arrow-clockwise"></i> Actualizar Pedidos
    </button>
  </form>
</div>

<!-- TABLA DE PEDIDOS -->
<div class="container mt-4">
  <div class="border rounded bg-white p-3 shadow-sm">
    <h5 class="mb-3">Pedidos</h5>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>N° PEDIDO</th>
            <th>CLIENTE</th>
            <th>FECHA</th>
            <th>TOTAL</th>
            <th>ESTADO</th>
            <th>ACCIÓN</th>
          </tr>
        </thead>
        <tbody>
          {% for pedido in pedidos %}
            <tr>
              <td>{{ pedido.id|stringformat:"06d" }}</td>
              <td>{{ pedido.id_cliente.nombre }} {{ pedido.id_cliente.apellido }}</td>
              <td>{{ pedido.fecha }}</td>
              <td>${{ pedido.total_pedido|floatformat:0 }}</td>
              <td>
                {% if pedido.estado == 'Pendiente' %}
                  <span class="badge bg-warning text-dark">Pendiente</span>
                {% elif pedido.estado == 'Aprobado' %}
                  <span class="badge bg-success">Aprobado</span>
                {% elif pedido.estado == 'Rechazado' %}
                  <span class="badge bg-danger">Rechazado</span>
                {% elif pedido.estado == 'Pagado' %}
                  <span class="badge bg-secondary">Pagado</span>
                {% else %}
                  <span class="badge bg-dark">{{ pedido.estado }}</span>
                {% endif %}
              </td>
              <td class="d-flex gap-2">
                {% if pedido.estado == 'Pendiente' %}
                  <form action="{% url 'Ferremas:aprobar_pedido' pedido.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm text-success" title="Aprobar">
                      <i class="bi bi-check-circle-fill"></i>
                    </button>
                  </form>
                  <form action="{% url 'Ferremas:rechazar_pedido' pedido.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm text-danger" title="Rechazar">
                      <i class="bi bi-x-circle-fill"></i>
                    </button>
                  </form>
                {% elif pedido.estado == 'Aprobado' or pedido.estado == 'Pagado' %}
                  <a href="{% url 'Ferremas:detalle_pedido' pedido.id %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye-fill"></i> Ver Detalle
                  </a>
                {% elif pedido.estado == 'Rechazado' %}
                  <form action="{% url 'Ferremas:reintentar_pedido' pedido.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-secondary btn-sm" title="Reintentar">
                      <i class="bi bi-arrow-repeat"></i> Reintentar
                    </button>
                  </form>
                {% else %}
                  <span class="text-muted">Sin acciones</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">No se encontraron pedidos.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="text-white text-center py-3 mt-auto" style="background-color: #005eff;">
  <div class="container">
    <p class="mb-1">&copy; 2025 FERREMAS. Todos los derechos reservados.</p>
    <small>Contáctanos: contacto@ferremas.cl | +56 9 1234 5678</small>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
